#!/bin/bash

set -e

BUILD_DIR=$1
CACHE_DIR=$2

# borrowed from: https://github.com/mojodna/heroku-buildpack-cairo/
function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

# borrowed from: https://github.com/mojodna/heroku-buildpack-cairo/
function vendor() {
  binary="$1"
  path="$2"

  echo "Fetching $binary" | indent
  mkdir -p $path
  curl $binary -s -o - | tar xz -C $path -f -

  if [ -d "$path/bin" ]; then
    export PATH=$path/bin:$PATH
  fi

  if [ -d "$path/lib/pkgconfig" ]; then
    # pkg-config should handle compiler options (if used)
    export PKG_CONFIG_PATH="$path/lib/pkgconfig:$PKG_CONFIG_PATH"
  fi

  # standard paths
  export CPPPATH="$path/include:$CPPPATH"
  export CPATH="$path/include:$CPATH"
  export LIBRARY_PATH="$path/lib:$LIBRARY_PATH"

  export LD_LIBRARY_PATH="$path/lib:$LD_LIBRARY_PATH"
}

vendor "https://s3.amazonaws.com/mojodna-heroku/$STACK/freetype-2.5.5-1.tar.gz" "$BUILD_DIR/vendor/freetype"
vendor "https://s3.amazonaws.com/mojodna-heroku/$STACK/fontconfig-2.11.93-1.tar.gz"  "$BUILD_DIR/vendor/fontconfig"

echo "-----> Tweaking FreeType include path"

export CPPPATH="$BUILD_DIR/vendor/freetype/include/freetype2:$CPPPATH"
export CPATH="$BUILD_DIR/vendor/freetype/include/freetype2:$CPATH"

echo "-----> Configuring build environment"

cat <<EOF > export
export PATH="$PATH:\$PATH"
export LD_LIBRARY_PATH="\$LD_LIBRARY_PATH:$LD_LIBRARY_PATH"
export LIBRARY_PATH="\$LIBRARY_PATH:$LIBRARY_PATH"
export PKG_CONFIG_PATH="\$PKG_CONFIG_PATH:$PKG_CONFIG_PATH"
export CPPPATH="\$CPPPATH:$CPPPATH"
export CPATH="\$CPATH:$CPATH"
EOF

# Poppler
VERSION="0.34.0"
FILE_NAME="poppler-${VERSION}.tar.xz"

mkdir -p $CACHE_DIR
if ! [ -e $CACHE_DIR/$FILE_NAME ]; then
  echo "-----> building Poppler buildpack binaries"
  cd $CACHE_DIR
  curl http://poppler.freedesktop.org/$FILE_NAME > $CACHE_DIR/$FILE_NAME
  tar -xJf $FILE_NAME
  cd "poppler-${VERSION}"
  DISABLED="--disable-abiword-output --disable-gtk-test --disable-poppler-qt --disable-poppler-qt4 --disable-splash-output --disable-gdk"
  ./configure --enable-static=yes --enable-shared=no --enable-libopenjpeg=none $DISABLE
  make
fi

echo "-----> Extracting Poppler binaries"
mkdir -p $BUILD_DIR/vendor/poppler
cp -rf $CACHE_DIR/poppler-$VERSION $BUILD_DIR/vendor/poppler

echo "-----> Linking binaries"
mkdir -p $BUILD_DIR/bin
cd $BUILD_DIR/bin
ln -s ../vendor/poppler/poppler-$VERSION/utils/pdftohtml .
ln -s ../vendor/poppler/poppler-$VERSION/utils/pdftotext .
ln -s ../vendor/poppler/poppler-$VERSION/utils/pdfinfo .
